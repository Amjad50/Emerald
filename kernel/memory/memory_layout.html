<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Memory Layout - Emerald</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../xtask/index.html"><strong aria-hidden="true">2.</strong> xtask</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../xtask/profiler.html"><strong aria-hidden="true">2.1.</strong> Profiler</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/index.html"><strong aria-hidden="true">3.</strong> Kernel</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/boot/index.html"><strong aria-hidden="true">3.1.</strong> Boot</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/boot/cmdline.html"><strong aria-hidden="true">3.1.1.</strong> Command Line</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/memory/index.html"><strong aria-hidden="true">3.2.</strong> Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/memory/memory_layout.html" class="active"><strong aria-hidden="true">3.2.1.</strong> Memory Layout</a></li><li class="chapter-item expanded "><a href="../../kernel/memory/physical_allocator.html"><strong aria-hidden="true">3.2.2.</strong> Physical Allocator</a></li><li class="chapter-item expanded "><a href="../../kernel/memory/virtual_mapper.html"><strong aria-hidden="true">3.2.3.</strong> Virtual Mapper</a></li><li class="chapter-item expanded "><a href="../../kernel/memory/virtual_space.html"><strong aria-hidden="true">3.2.4.</strong> Virtual Space</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/drivers/index.html"><strong aria-hidden="true">3.3.</strong> Drivers/Devices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/drivers/ide.html"><strong aria-hidden="true">3.3.1.</strong> IDE</a></li><li class="chapter-item expanded "><a href="../../kernel/drivers/keyboard.html"><strong aria-hidden="true">3.3.2.</strong> Keyboard</a></li><li class="chapter-item expanded "><a href="../../kernel/drivers/mouse.html"><strong aria-hidden="true">3.3.3.</strong> Mouse</a></li><li class="chapter-item expanded "><a href="../../kernel/drivers/uart.html"><strong aria-hidden="true">3.3.4.</strong> UART</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/virtual_devices/index.html"><strong aria-hidden="true">3.4.</strong> Virtual Devices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/virtual_devices/console.html"><strong aria-hidden="true">3.4.1.</strong> Console</a></li><li class="chapter-item expanded "><a href="../../kernel/virtual_devices/pipe.html"><strong aria-hidden="true">3.4.2.</strong> Pipe</a></li><li class="chapter-item expanded "><a href="../../kernel/virtual_devices/power.html"><strong aria-hidden="true">3.4.3.</strong> Power</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/filesystem/index.html"><strong aria-hidden="true">3.5.</strong> Filesystem</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/filesystem/fat.html"><strong aria-hidden="true">3.5.1.</strong> FAT</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/network/index.html"><strong aria-hidden="true">3.6.</strong> Network</a></li><li class="chapter-item expanded "><a href="../../kernel/processor/index.html"><strong aria-hidden="true">3.7.</strong> Processor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/processor/interrupts.html"><strong aria-hidden="true">3.7.1.</strong> Interrupts and Exceptions</a></li><li class="chapter-item expanded "><a href="../../kernel/processor/gdt.html"><strong aria-hidden="true">3.7.2.</strong> GDT and others</a></li><li class="chapter-item expanded "><a href="../../kernel/processor/apic.html"><strong aria-hidden="true">3.7.3.</strong> APIC</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/acpi/index.html"><strong aria-hidden="true">3.8.</strong> ACPI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/acpi/aml.html"><strong aria-hidden="true">3.8.1.</strong> AML</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/processes/index.html"><strong aria-hidden="true">3.9.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/processes/scheduler.html"><strong aria-hidden="true">3.9.1.</strong> Scheduler</a></li><li class="chapter-item expanded "><a href="../../kernel/processes/syscalls.html"><strong aria-hidden="true">3.9.2.</strong> Syscalls</a></li><li class="chapter-item expanded "><a href="../../kernel/processes/executables.html"><strong aria-hidden="true">3.9.3.</strong> Executables</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/clocks/index.html"><strong aria-hidden="true">3.10.</strong> Clocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/clocks/rtc.html"><strong aria-hidden="true">3.10.1.</strong> RTC</a></li><li class="chapter-item expanded "><a href="../../kernel/clocks/hpet.html"><strong aria-hidden="true">3.10.2.</strong> HPET</a></li><li class="chapter-item expanded "><a href="../../kernel/clocks/pit.html"><strong aria-hidden="true">3.10.3.</strong> PIT</a></li><li class="chapter-item expanded "><a href="../../kernel/clocks/tsc.html"><strong aria-hidden="true">3.10.4.</strong> TSC</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/graphics/index.html"><strong aria-hidden="true">3.11.</strong> Graphics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../kernel/graphics/vga.html"><strong aria-hidden="true">3.11.1.</strong> VGA</a></li></ol></li><li class="chapter-item expanded "><a href="../../kernel/testing/index.html"><strong aria-hidden="true">3.12.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../../kernel/logging/index.html"><strong aria-hidden="true">3.13.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../../kernel/power/index.html"><strong aria-hidden="true">3.14.</strong> Power</a></li></ol></li><li class="chapter-item expanded "><a href="../../userspace/index.html"><strong aria-hidden="true">4.</strong> Userspace</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../userspace/programs.html"><strong aria-hidden="true">4.1.</strong> Programs</a></li><li class="chapter-item expanded "><a href="../../userspace/libraries.html"><strong aria-hidden="true">4.2.</strong> Libraries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../userspace/rust_std.html"><strong aria-hidden="true">4.2.1.</strong> Rust Standard Library</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../extra/index.html"><strong aria-hidden="true">5.</strong> Extra</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../extra/heap_allocator.html"><strong aria-hidden="true">5.1.</strong> Heap Allocator</a></li><li class="chapter-item expanded "><a href="../../extra/kernel_user_link.html"><strong aria-hidden="true">5.2.</strong> Kernel User Link</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Emerald</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Amjad50/Emerald" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="memory-layout"><a class="header" href="#memory-layout">Memory layout</a></h1>
<blockquote>
<p>The memory layout constants and code is defined in <a href="/Emerald/docs/kernel/memory_management/memory_layout"><code>memory_layout</code></a></p>
</blockquote>
<p>This is the structure of the memory for any process running in the system.</p>
<h2 id="layout"><a class="header" href="#layout">Layout</a></h2>
<pre><code class="language-txt">0000_0000_0000_0000 .. FFFF_FF7F_FFFF_FFFF - User   (15.99~ EB)
FFFF_FF80_0000_0000 .. FFFF_FFFF_7FFF_FFFF - Process specific kernel (510 GB)
FFFF_FFFF_8000_0000 .. FFFF_FFFF_FFFF_FFFF - Kernel (2 GB)
</code></pre>
<h3 id="kernel-layout"><a class="header" href="#kernel-layout">Kernel layout</a></h3>
<pre><code class="language-txt">FFFF_FFFF_8000_0000..FFFF_FFFF_8010_0000          nothing
FFFF_FFFF_8010_0000..FFFF_FFFF_8XXX_XXXX          kernel elf (text, rodata, data, bss)
FFFF_FFFF_8XXX_XXXX..FFFF_FFFF_8800_0000          (kernel end) physical allocator low (until 128MB mark pre-mapped in `boot`)
FFFF_FFFF_8800_0000..FFFF_FFFF_8900_0000          kernel heap (16MB)
FFFF_FFFF_8900_0000..FFFF_FFFF_890E_7000          interrupt stacks
    FFFF_FFFF_8900_0000..FFFF_FFFF_8900_1000      interrupt stack 0 guard page (4KB) *not mapped by purpose*
    FFFF_FFFF_8900_1000..FFFF_FFFF_8902_1000      interrupt stack 0 (32 * 4KB = 128KB)
    ... *repeat for 6 more stacks*
FFFF_FFFF_890E_7000..FFFF_FFFF_FFFF_F000          Kernel extra (virtual space, free virtual space to use)
</code></pre>
<p>The kernel is loaded by the bootloader at physical address <code>0x10_0000</code>, and then it will
perform virtual mapping for physical <code>0x0</code> into <code>0xFFFF_FFFF_8000_0000</code> for <code>128MB</code>
i.e. until the end of the initial <code>physical page allocator</code>. See more details in the <a href="../boot.html">boot</a> chapter.</p>
<p>Look at <a href="./virtual_space.html">virtual space</a> for more info on it.</p>
<h4 id="virtual-space"><a class="header" href="#virtual-space">Virtual space</a></h4>
<p>Virtual space is a I'm using (not sure what other OSes call), that solves the issue of &quot;I have a physical address of an object, but I don't have virtual space to map it to&quot;.
This is useful for reading structures that are in specific location in physical memory, such as <code>ACPI</code> tables, <code>PCI</code> configuration space, <code>memory mapped IO</code>, etc.</p>
<p>Its very simple, it will take memory from the <code>kernel extra</code> space, and map it to the physical address.</p>
<h3 id="process-specific-kernel-layout"><a class="header" href="#process-specific-kernel-layout">Process specific kernel layout</a></h3>
<pre><code class="language-txt">FFFF_FF80_0000_0000..FFFF_FF80_0000_1000          process kernel stack guard page (4KB) *not mapped by purpose*
FFFF_FF80_0000_1000..FFFF_FF80_0004_1000          process kernel stack (64 * 4KB = 256KB)
</code></pre>
<p>This is a space specific to each process, but reside in kernel space.</p>
<p>The idea is to have structures that are specific to processes here, that others won't have access and thus reduce the need to setup a lock around them.</p>
<p>We use it currently for <code>kernel stack</code>, which is where the kernel will store the stack when an interrupt happens while we are in user space.</p>
<p>It solves the issue where having a single kernel stack for all processes can't work, as if two processes gets interrupted while the first one is still in the kernel, the second one will overwrite the first one's stack.</p>
<blockquote>
<p>As you might have expect, the previous paragraph was a source of a crazy bug that introduced this <code>kernel stack</code>. Fixed in <a href="https://github.com/Amjad50/Emerald/commit/0dc04f8">0dc04f8</a></p>
</blockquote>
<h3 id="user-layout"><a class="header" href="#user-layout">User layout</a></h3>
<p>Not much to talk about here, as this will depend on the process itself and where to load the ELF file, currently we load at the address specified in the ELF file.
This is of course not safe, as we don't do extra checks for that value.</p>
<p>But anyway, the other parts of the userspace are as follows:</p>
<pre><code class="language-txt">XXXX_XXXX_XXXX_XXXX .. YYYY_YYYY_YYYY_YYYY - ELF file
YYYY_YYYY_YYYY_YYYY .. ZZZZ_ZZZZ_ZZZZ_ZZZZ - Heap. From the end of the ELF and grows up
ZZZZ_ZZZZ_ZZZZ_ZZZZ .. FFFF_FF7F_FFFF_D000 - Stack. From the top and grows down
FFFF_FF7F_FFFF_D000 .. FFFF_FF7F_FFFF_E000 - Stack guard page. *not mapped, just for reference*
FFFF_FF7F_FFFF_E000 .. FFFF_FF7F_FFFF_F000 - Process Metadata structure
</code></pre>
<p>A lot of symbols XD. But in general, the stack is at the top of the user space, and the elf file is at the bottom,
and the heap is in the middle starts after the elf file.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../kernel/memory/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../kernel/memory/physical_allocator.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../kernel/memory/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../kernel/memory/physical_allocator.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
