<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Profiler - Emerald</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../xtask/index.html"><strong aria-hidden="true">2.</strong> xtask</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../xtask/profiler.html" class="active"><strong aria-hidden="true">2.1.</strong> Profiler</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/index.html"><strong aria-hidden="true">3.</strong> Kernel</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/boot/index.html"><strong aria-hidden="true">3.1.</strong> Boot</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/boot/cmdline.html"><strong aria-hidden="true">3.1.1.</strong> Command Line</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/memory/index.html"><strong aria-hidden="true">3.2.</strong> Memory</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/memory/memory_layout.html"><strong aria-hidden="true">3.2.1.</strong> Memory Layout</a></li><li class="chapter-item expanded "><a href="../kernel/memory/physical_allocator.html"><strong aria-hidden="true">3.2.2.</strong> Physical Allocator</a></li><li class="chapter-item expanded "><a href="../kernel/memory/virtual_mapper.html"><strong aria-hidden="true">3.2.3.</strong> Virtual Mapper</a></li><li class="chapter-item expanded "><a href="../kernel/memory/virtual_space.html"><strong aria-hidden="true">3.2.4.</strong> Virtual Space</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/drivers/index.html"><strong aria-hidden="true">3.3.</strong> Drivers/Devices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/drivers/ide.html"><strong aria-hidden="true">3.3.1.</strong> IDE</a></li><li class="chapter-item expanded "><a href="../kernel/drivers/keyboard.html"><strong aria-hidden="true">3.3.2.</strong> Keyboard</a></li><li class="chapter-item expanded "><a href="../kernel/drivers/mouse.html"><strong aria-hidden="true">3.3.3.</strong> Mouse</a></li><li class="chapter-item expanded "><a href="../kernel/drivers/uart.html"><strong aria-hidden="true">3.3.4.</strong> UART</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/virtual_devices/index.html"><strong aria-hidden="true">3.4.</strong> Virtual Devices</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/virtual_devices/console.html"><strong aria-hidden="true">3.4.1.</strong> Console</a></li><li class="chapter-item expanded "><a href="../kernel/virtual_devices/pipe.html"><strong aria-hidden="true">3.4.2.</strong> Pipe</a></li><li class="chapter-item expanded "><a href="../kernel/virtual_devices/power.html"><strong aria-hidden="true">3.4.3.</strong> Power</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/filesystem/index.html"><strong aria-hidden="true">3.5.</strong> Filesystem</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/filesystem/fat.html"><strong aria-hidden="true">3.5.1.</strong> FAT</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/network/index.html"><strong aria-hidden="true">3.6.</strong> Network</a></li><li class="chapter-item expanded "><a href="../kernel/processor/index.html"><strong aria-hidden="true">3.7.</strong> Processor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/processor/interrupts.html"><strong aria-hidden="true">3.7.1.</strong> Interrupts and Exceptions</a></li><li class="chapter-item expanded "><a href="../kernel/processor/gdt.html"><strong aria-hidden="true">3.7.2.</strong> GDT and others</a></li><li class="chapter-item expanded "><a href="../kernel/processor/apic.html"><strong aria-hidden="true">3.7.3.</strong> APIC</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/acpi/index.html"><strong aria-hidden="true">3.8.</strong> ACPI</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/acpi/aml.html"><strong aria-hidden="true">3.8.1.</strong> AML</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/processes/index.html"><strong aria-hidden="true">3.9.</strong> Processes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/processes/scheduler.html"><strong aria-hidden="true">3.9.1.</strong> Scheduler</a></li><li class="chapter-item expanded "><a href="../kernel/processes/syscalls.html"><strong aria-hidden="true">3.9.2.</strong> Syscalls</a></li><li class="chapter-item expanded "><a href="../kernel/processes/executables.html"><strong aria-hidden="true">3.9.3.</strong> Executables</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/clocks/index.html"><strong aria-hidden="true">3.10.</strong> Clocks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/clocks/rtc.html"><strong aria-hidden="true">3.10.1.</strong> RTC</a></li><li class="chapter-item expanded "><a href="../kernel/clocks/hpet.html"><strong aria-hidden="true">3.10.2.</strong> HPET</a></li><li class="chapter-item expanded "><a href="../kernel/clocks/pit.html"><strong aria-hidden="true">3.10.3.</strong> PIT</a></li><li class="chapter-item expanded "><a href="../kernel/clocks/tsc.html"><strong aria-hidden="true">3.10.4.</strong> TSC</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/graphics/index.html"><strong aria-hidden="true">3.11.</strong> Graphics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../kernel/graphics/vga.html"><strong aria-hidden="true">3.11.1.</strong> VGA</a></li></ol></li><li class="chapter-item expanded "><a href="../kernel/testing/index.html"><strong aria-hidden="true">3.12.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../kernel/logging/index.html"><strong aria-hidden="true">3.13.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../kernel/power/index.html"><strong aria-hidden="true">3.14.</strong> Power</a></li></ol></li><li class="chapter-item expanded "><a href="../userspace/index.html"><strong aria-hidden="true">4.</strong> Userspace</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../userspace/programs.html"><strong aria-hidden="true">4.1.</strong> Programs</a></li><li class="chapter-item expanded "><a href="../userspace/libraries.html"><strong aria-hidden="true">4.2.</strong> Libraries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../userspace/rust_std.html"><strong aria-hidden="true">4.2.1.</strong> Rust Standard Library</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../extra/index.html"><strong aria-hidden="true">5.</strong> Extra</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extra/heap_allocator.html"><strong aria-hidden="true">5.1.</strong> Heap Allocator</a></li><li class="chapter-item expanded "><a href="../extra/kernel_user_link.html"><strong aria-hidden="true">5.2.</strong> Kernel User Link</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Emerald</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/Amjad50/Emerald" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="profiler"><a class="header" href="#profiler">Profiler</a></h1>
<p>Profiling the kernel is one of the most important tasks we have in order to improve its performance.</p>
<p>I was thinking first, about making a trace of the kernel state interrupts, but that would have some issues:</p>
<ul>
<li>Hard to implement and export the data (maybe export to disk?).</li>
<li>The analysis would also be part of the trace, which would make it more annoying to separate the real data from trace
processing calls.</li>
</ul>
<h2 id="qemu-qmp"><a class="header" href="#qemu-qmp">Qemu (QMP)</a></h2>
<p>Qemu has an interface to communicate and analyze the guest system from outside, called QMP (Qemu Machine Protocol).
It allows us to send commands to the Qemu instance and get the results back.</p>
<p>Such as:</p>
<ul>
<li><code>stop</code>: Pause the Qemu instance.</li>
<li><code>cont</code>: Continue the Qemu instance.</li>
<li><code>human-monitor</code>: Send gdb like commands to the Qemu instance.
<ul>
<li>such as <code>info registers</code> to get the current state of the registers.</li>
<li><code>x/1x ...</code> read memory at the given address.</li>
</ul>
</li>
</ul>
<p>Using all of that we have built a profiler in <code>xtask</code> that does the following:</p>
<ul>
<li>Read the dwarf information and the symbols information form the kernel binary, and store it.</li>
<li>Load userspace program symbols from ELF files in the userspace output directory, using <code>.text</code> section hashes for identification.</li>
<li>Connect to the Qemu instance using QMP.</li>
<li>On every interval (configured)
<ul>
<li>Stop the Qemu instance. (to keep the memory state consistent, even though it can sample without stopping).</li>
<li>Get <code>RIP</code>, <code>RSP</code>, <code>RBP</code> registers of the CPU (currently, we have 1 CPU only).</li>
<li>Detect whether execution is in kernel or userspace based on the instruction pointer address.</li>
<li>For userspace execution: read process metadata, dynamically load userspace module symbols and unwinding info.</li>
<li>Use <a href="https://github.com/mstange/framehop"><code>framehop</code></a> to trace the stack using these variables as well as the gdb command to
read any memory address.</li>
<li>Use the symbols to resolve the function names for each stack frame (both kernel and userspace).</li>
<li>Group them together in 1 collapsed stack trace with process identification.</li>
</ul>
</li>
<li>Collect all collapsed stack traces and their counts into one file.</li>
</ul>
<p>The collected collapsed stacks are then used to generate flamegraph (<a href="https://www.speedscope.app">https://www.speedscope.app</a> is a good tool for viewing these files).</p>
<h2 id="how-to-use"><a class="header" href="#how-to-use">How to use</a></h2>
<p>In order to profile the OS, the easiest way is to use <code>xtask</code> with profiling commands:</p>
<pre><code class="language-sh"># Run the kernel in profiling mode
cargo xtask --profile run

# In another terminal, run the profiler
cargo xtask profiler -o stack.folded
</code></pre>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<h3 id="kernel-and-userspace-profiling"><a class="header" href="#kernel-and-userspace-profiling">Kernel and Userspace Profiling</a></h3>
<p>The profiler supports both kernel and userspace execution profiling:</p>
<ul>
<li><strong>Kernel profiling</strong>: Traces execution within the kernel using kernel symbols and DWARF debug information</li>
<li><strong>Userspace profiling</strong>: Dynamically detects userspace processes and loads their symbols for accurate stack unwinding</li>
<li><strong>Process identification</strong>: Tracks individual processes by PID and program name in stack traces</li>
</ul>
<h3 id="symbol-resolution"><a class="header" href="#symbol-resolution">Symbol Resolution</a></h3>
<ul>
<li>Loads ELF debug information from kernel binary at startup</li>
<li>Caches userspace program symbols using <code>.text</code> section hashes for efficient lookup</li>
<li>Falls back to raw addresses when symbols are unavailable (or couldn't load the process metadata)</li>
</ul>
<h3 id="stack-unwinding"><a class="header" href="#stack-unwinding">Stack Unwinding</a></h3>
<ul>
<li>Uses the <a href="https://github.com/mstange/framehop"><code>framehop</code></a> library</li>
<li>Supports x86_64 DWARF-based unwinding using <code>.eh_frame</code> sections</li>
<li>Handles both kernel and userspace stack frames in mixed traces</li>
<li>Dynamically switches between kernel and userspace unwinding contexts</li>
</ul>
<h3 id="sampling-modes"><a class="header" href="#sampling-modes">Sampling Modes</a></h3>
<ul>
<li><strong>One-shot mode</strong>: Captures a single stack trace for immediate analysis</li>
<li><strong>Continuous sampling</strong>: Collects samples over a specified duration with configurable intervals</li>
<li><strong>Configurable timing</strong>: Adjustable sampling interval (default 10ms) and duration (default 5s)</li>
</ul>
<h3 id="output-formats"><a class="header" href="#output-formats">Output Formats</a></h3>
<ul>
<li><strong>Console output</strong>: Real-time stack traces with statistics</li>
<li><strong>Folded stack format</strong>: Compatible with flamegraph tools for visualization</li>
<li><strong>Process tracking</strong>: Identifies samples by kernel vs userspace and specific process names</li>
</ul>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>The profiler is run through the <code>xtask</code> command:</p>
<pre><code class="language-bash"># Basic profiling for 5 seconds
cargo xtask --profile profiler

# One-shot stack trace
cargo xtask --profile profiler --one-shot

# Extended sampling with custom parameters
cargo xtask --profile profiler --duration 30 --interval 5 --output profile.folded

# Verbose output with addresses
cargo xtask --profile profiler --verbose --show-addresses --one-shot
</code></pre>
<h3 id="command-line-options"><a class="header" href="#command-line-options">Command Line Options</a></h3>
<ul>
<li><code>--qmp-socket &lt;path&gt;</code>: QMP socket path (default: ./qmp-socket)</li>
<li><code>--interval &lt;ms&gt;</code>: Sampling interval in milliseconds (default: 10)</li>
<li><code>--duration &lt;sec&gt;</code>: Sampling duration in seconds (default: 5)</li>
<li><code>--output &lt;file&gt;</code>: Output file for folded stack samples</li>
<li><code>--verbose</code>: Enable detailed output including timing information</li>
<li><code>--show-addresses</code>: Show raw addresses alongside symbols (only in <code>--one-shot</code> mode)</li>
<li><code>--one-shot</code>: Capture single stack trace and exit</li>
<li><code>--profile &lt;mode&gt;</code>: Override profile mode (debug/release/profile)</li>
<li><code>--kernel-only</code>: Only profile kernel execution, skip userspace</li>
<li><code>--user-only</code>: Only profile userspace execution, skip kernel</li>
</ul>
<h2 id="implementation-details"><a class="header" href="#implementation-details">Implementation Details</a></h2>
<h3 id="process-detection"><a class="header" href="#process-detection">Process Detection</a></h3>
<p>The profiler distinguishes between kernel and userspace execution by examining the instruction pointer:</p>
<ul>
<li>Addresses â‰¥ <code>0xFFFFFFFF80000000</code> are considered kernel space</li>
<li>Lower addresses trigger userspace process metadata collection</li>
</ul>
<h3 id="dynamic-symbol-loading"><a class="header" href="#dynamic-symbol-loading">Dynamic Symbol Loading</a></h3>
<p>For userspace processes, the profiler:</p>
<ol>
<li>Reads process metadata from a fixed kernel memory location</li>
<li>Extracts <code>.text</code> and <code>.eh_frame</code> sections from process memory</li>
<li>Computes a hash of the <code>.text</code> section for symbol cache lookup</li>
<li>Dynamically loads matching symbols and unwinding information</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../xtask/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../kernel/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../xtask/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../kernel/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
